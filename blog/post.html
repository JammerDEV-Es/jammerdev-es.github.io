<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width,initial-scale=1">
  <title>Entrada - JammerDev</title>
  <meta name="description" content="Entrada del blog JammerDev">
  <style>
    :root{
      --bg:#1e1e1e;--ter:#2d2d30;--pri:#060404;
      --accent:#b46114;--accent-light:#b97c20;--accent-weak:rgba(180,97,20,.18);
      --text:#e1e4e8;--muted:#858585;--border:#3e3e42;
    }
    html,body{height:100%;margin:0;background:linear-gradient(180deg,var(--bg),#000);color:var(--text);font-family:Segoe UI,Roboto,Arial,sans-serif}

    /* Top nav (back/breadcrumb) */
    .post-nav{position:sticky;top:0;z-index:10;display:flex;align-items:center;gap:.8rem;padding:.6rem .9rem;background:rgba(30,30,30,.9);backdrop-filter:blur(8px);border-bottom:1px solid var(--border)}
    .post-nav .back-btn{appearance:none;border:1px solid var(--border);background:transparent;color:var(--text);padding:.45rem .7rem;border-radius:8px;cursor:pointer;font-weight:700}
    .post-nav .back-btn:hover{border-color:var(--accent);transform:translateY(-1px)}
    .post-nav .brand{color:var(--accent-light);font-weight:800;text-decoration:none}
    .post-nav .crumb{color:var(--muted)}
    .spacer{flex:1}

    /* Wrapper */
    .wrap{max-width:980px;margin:18px auto;padding:0 16px}

    /* Hero */
    .hero{background:linear-gradient(180deg,rgba(45,45,48,.85),rgba(30,30,30,.95));border:1px solid var(--border);border-radius:14px;overflow:hidden}
    .hero-media{position:relative;max-height:340px;overflow:hidden;background:#111}
    .hero-media img{width:100%;height:100%;object-fit:cover;display:block}
    .hero-body{padding:20px 22px}
    .title{margin:0 0 6px;color:var(--accent-light);font-size:1.9rem;line-height:1.25}
    .meta{display:flex;flex-wrap:wrap;gap:.7rem;color:var(--muted);font-size:.92rem;margin:6px 0 2px}
    .meta .dot::before{content:'•';margin:0 .45rem;color:var(--muted)}
    .badges{display:flex;flex-wrap:wrap;gap:.4rem;margin-top:.6rem}
    .badge{background:var(--accent-weak);color:var(--accent-light);border:1px solid rgba(180,97,20,.35);padding:.18rem .55rem;border-radius:999px;font-size:.8rem;font-weight:700;text-decoration:none}

    /* Article */
    article{background:var(--ter);border:1px solid var(--border);border-radius:12px;margin-top:14px;padding:22px}
    article .content{line-height:1.75;color:var(--text)}
    article .content h1,article .content h2,article .content h3{color:var(--accent-light)}
    article .content pre{background:#101010;border:1px solid #222;border-radius:8px;padding:12px;overflow:auto}
    article .content code{background:rgba(180,97,20,.12);border:1px solid rgba(180,97,20,.25);padding:.1rem .3rem;border-radius:.25rem}
    article .content a{color:var(--accent-light);text-decoration:none;border-bottom:1px dashed rgba(180,97,20,.35)}
    article .content a:hover{color:var(--accent)}

    /* Post footer: share + prev/next */
    .post-actions{display:flex;flex-wrap:wrap;gap:.6rem;align-items:center;justify-content:space-between;margin-top:18px}
    .share{display:flex;gap:.5rem;align-items:center}
    .btn{appearance:none;border:1px solid var(--border);background:transparent;color:var(--text);padding:.55rem .8rem;border-radius:8px;cursor:pointer;font-weight:700;text-decoration:none}
    .btn.primary{background:var(--accent);border-color:transparent;color:#111}
    .btn:hover{border-color:var(--accent);transform:translateY(-1px)}

    .nav-cards{display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:.8rem;margin-top:14px}
    .nav-card{border:1px solid var(--border);background:linear-gradient(180deg,rgba(45,45,48,.6),rgba(30,30,30,.9));border-radius:10px;padding:12px;text-decoration:none;color:var(--text)}
    .nav-card .hint{font-size:.78rem;color:var(--muted);margin-bottom:.2rem}
    .nav-card .nav-title{color:var(--accent-light);font-weight:800}

    /* Related */
    .related{margin-top:16px}
    .related h3{color:var(--accent-light);margin:0 0 8px}
    .rel-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(220px,1fr));gap:.8rem}
    .rel-item{border:1px solid var(--border);background:rgba(45,45,48,.55);border-radius:10px;padding:10px}
    .rel-item a{color:var(--accent);text-decoration:none}

    /* Footer back link */
    .back-bottom{display:flex;justify-content:center;margin:22px 0}

    @media (max-width:640px){
      .title{font-size:1.4rem}
      .hero-media{max-height:220px}
      article{padding:16px}
    }
  </style>
</head>
<body>
  <nav class="post-nav">
    <button class="back-btn" id="backBtn" aria-label="Return">← Return</button>
    <a class="brand" href="../" id="brandLink">Blog</a>
    <span class="crumb">/</span>
    <span class="crumb" id="crumbTitle">Entrada</span>
    <div class="spacer"></div>
  </nav>

  <div class="wrap">
    <section class="hero" id="hero">
      <div class="hero-media" id="heroMedia" hidden></div>
      <div class="hero-body">
        <h1 class="title" id="title">Cargando…</h1>
        <div class="meta" id="meta"></div>
        <div class="badges" id="badges"></div>
      </div>
    </section>

    <article>
      <div class="content" id="content">Cargando…</div>
      <!-- acciones de compartir y navegación Anterior/Siguiente eliminadas -->
    </article>

    <section class="related" id="related" hidden>
      <h3>También puede interesarte</h3>
      <div class="rel-grid" id="relGrid"></div>
    </section>

    <div class="back-bottom">
      <a class="btn primary" id="backBottom">Return to blog</a>
    </div>
  </div>

  <script>
    function qs(name){ const u=new URLSearchParams(window.location.search); return u.get(name); }
    function formatDate(d){ const dt=new Date(d); return dt.toLocaleDateString(undefined,{year:'numeric',month:'short',day:'numeric'}); }
    function escapeHtml(s){ return String(s||'').replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;'); }
    function sameOriginRef(){ try{ return document.referrer && new URL(document.referrer).origin === location.origin; }catch(_){ return false; } }
    function backOrHome(){ if(history.length>1 && sameOriginRef()){ history.back(); } else { location.assign('../'); } }

    function wordsCount(str){ return (str||'').trim().split(/\s+/).filter(Boolean).length; }
    function readingTime(str){ const w = wordsCount(str); const m = Math.max(1, Math.round(w/200)); return m + ' min read'; }

    // Minimal markdown to HTML (supports #, ##, ###, bold, italic, `code`, ``` blocks, paragraphs, links)
    function mdToHtml(md){
      if(!md) return '';
      const parts = String(md).replace(/\r\n/g,'\n').split(/```([\s\S]*?)```/g);
      let html='';
      for(let i=0;i<parts.length;i++){
        if(i%2===1){ // code block content
          html += '<pre><code>' + escapeHtml(parts[i]) + '</code></pre>';
        }else{
          const block = parts[i]
            .split('\n')
            .map(line=>{
              if(/^###\s+/.test(line)) return '<h3>'+escapeHtml(line.replace(/^###\s+/,'').trim())+'</h3>';
              if(/^##\s+/.test(line))  return '<h2>'+escapeHtml(line.replace(/^##\s+/,'').trim())+'</h2>';
              if(/^#\s+/.test(line))   return '<h1>'+escapeHtml(line.replace(/^#\s+/,'').trim())+'</h1>';
              return escapeHtml(line);
            })
            .join('\n');
          // inline formatting
          let inline = block;
          inline = inline.replace(/\*\*([^*]+)\*\*/g,'<strong>$1</strong>');
          inline = inline.replace(/\*([^*]+)\*/g,'<em>$1</em>');
          inline = inline.replace(/`([^`]+)`/g,'<code>$1</code>');
          // autolink
          inline = inline.replace(/(https?:\/\/[^\s<]+[^<.,;:\)\]\s])/g,'<a href="$1" target="_blank" rel="noopener">$1<\/a>');
          // paragraphs (split by two or more newlines)
          inline = inline.split(/\n{2,}/).map(p=>'<p>'+p.replace(/\n/g,'<br>')+'</p>').join('');
          html += inline;
        }
      }
      return html;
    }

    (async function(){
      const id = qs('id');
      const titleEl = document.getElementById('title');
      const crumbTitle = document.getElementById('crumbTitle');
      const metaEl = document.getElementById('meta');
      const badgesEl = document.getElementById('badges');
      const contentEl = document.getElementById('content');
      const heroMedia = document.getElementById('heroMedia');
            const rel = document.getElementById('related');
      const relGrid = document.getElementById('relGrid');

      document.getElementById('backBtn').addEventListener('click', backOrHome);
      document.getElementById('backBottom').addEventListener('click', function(e){ e.preventDefault(); backOrHome(); });

      try{
        const res = await fetch('./posts.json');
        if(!res.ok) throw new Error('HTTP ' + res.status);
        const posts = await res.json();
        const idx = posts.findIndex(p=>String(p.id) === String(id));
        const post = idx>=0 ? posts[idx] : null;
        if(!post){
          titleEl.textContent = 'Entrada no encontrada';
          metaEl.textContent = 'id='+ (id||'')
          contentEl.textContent = 'No se encontró la entrada solicitada.';
          return;
        }

        // Title and meta
        document.title = (post.title||'Entrada') + ' - JammerDev';
        titleEl.textContent = post.title || 'Sin título';
        crumbTitle.textContent = post.title || 'Entrada';

        const metaBits = [
          formatDate(post.date||new Date()),
          readingTime(post.content||'')
        ];
        if(typeof post.views === 'number') metaBits.push(post.views + ' vistas');
        metaEl.textContent = metaBits.join(' • ');

        // Badges: category + tags
        badgesEl.innerHTML = '';
        const catArr = Array.isArray(post.categories)? post.categories : (post.category ? [post.category]: []);
        catArr.forEach(c=>{
          const a=document.createElement('a'); a.href='../'; a.className='badge'; a.textContent=c; badgesEl.appendChild(a);
        });
        const tags = Array.isArray(post.tags)? post.tags : (post.tag ? [post.tag] : []);
        tags.forEach(t=>{ const a=document.createElement('a'); a.href='../'; a.className='badge'; a.textContent='#'+t; badgesEl.appendChild(a); });

        // Cover/thumbnail in hero
        const cover = post.cover || post.thumbnail || (post.attachment && post.attachment.type && post.attachment.type.startsWith('image/') ? post.attachment.data : null);
        if(cover){
          const img=document.createElement('img'); img.src=cover; img.alt=post.title||'cover'; heroMedia.appendChild(img); heroMedia.hidden=false;
        }

        // Content (markdown-light)
        contentEl.innerHTML = mdToHtml(post.content||'');

        // Attachments (non-image)
        if(post.attachment && post.attachment.data){
          const isImage = post.attachment.type && post.attachment.type.startsWith('image/');
          if(!isImage){
            const a = document.createElement('a'); a.href = post.attachment.data; a.download = post.attachment.name||''; a.className='btn'; a.textContent = 'Descargar adjunto'; contentEl.appendChild(document.createElement('br')); contentEl.appendChild(a);
          }
        }

        // compartir y prev/sig eliminados

        // Related by tags/category
        const relCandidates = posts.filter(p=> String(p.id)!==String(post.id));
        const hasCommon = (a,b)=>{
          const at = new Set((Array.isArray(a.tags)?a.tags:(a.tag?[a.tag]:[])).map(String));
          const bt = new Set((Array.isArray(b.tags)?b.tags:(b.tag?[b.tag]:[])).map(String));
          const ac = new Set((Array.isArray(a.categories)?a.categories:(a.category?[a.category]:[])).map(String));
          const bc = new Set((Array.isArray(b.categories)?b.categories:(b.category?[b.category]:[])).map(String));
          for(const t of at){ if(bt.has(t)) return true; }
          for(const c of ac){ if(bc.has(c)) return true; }
          return false;
        };
        const related = relCandidates.filter(p=>hasCommon(post,p)).slice(0,3);
        if(related.length){
          rel.hidden=false; relGrid.innerHTML='';
          related.forEach(r=>{
            const it=document.createElement('div'); it.className='rel-item';
            const th = r.thumbnail||r.cover;
            it.innerHTML = (th?'<img src="'+escapeHtml(th)+'" alt="'+escapeHtml(r.title||'')+'" style="width:100%;height:120px;object-fit:cover;border-radius:6px;margin-bottom:6px;border:1px solid rgba(255,255,255,.05)">':'')+
              '<div style="font-size:.8rem;color:var(--muted);margin-bottom:.2rem">'+escapeHtml(formatDate(r.date||new Date()))+'</div>'+
              '<div style="font-weight:800;color:var(--accent-light);margin-bottom:.25rem">'+escapeHtml(r.title||'')+'</div>'+
              '<a href="post.html?id='+encodeURIComponent(r.id)+'">Leer más →</a>';
            relGrid.appendChild(it);
          });
        }
      }catch(e){
        document.getElementById('title').textContent = 'Error cargando entrada';
        document.getElementById('content').textContent = 'Error: '+(e && e.message || e);
        console.error(e);
      }
    })();

    // Navigation controls
    document.getElementById('brandLink').addEventListener('click', function(ev){ ev.preventDefault(); backOrHome(); });
  </script>
</body>
</html>

